<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>同時ゴール司令塔</title>
<style>
body { font-family:sans-serif; background:#f5f7fa; padding:20px; text-align:center; }
.person { display:flex; gap:10px; margin-bottom:10px; }
input { padding:8px; font-size:16px; flex:1; }
button { padding:12px; font-size:18px; margin-top:10px; width:100%; }
#mainTimer { font-size:64px; margin-top:20px; font-weight:bold; }
.stopBtn { background:#ff4d4d; color:white; }
.tabs button { width:48%; }
.active { background:#333; color:white; }
</style>
</head>
<body>

<h1>同時ゴール司令塔</h1>

<div class="tabs">
  <button id="upTab" class="active" onclick="switchMode('up')">カウントアップ（遠）</button>
  <button id="downTab" onclick="switchMode('down')">カウントダウン（近）</button>
</div>

<div id="inputs"></div>
<button onclick="addPerson()">参加者を追加</button>
<button onclick="calculate()">計算する</button>

<div id="startArea"></div>
<div id="mainTimer"></div>

<script>
let mode = "up";
let startTimes = [];
let downStartTimes = [];
let audioCtx;
let interval = null;
let t = 0;
let endTime = null;

function initAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function tone(freq, duration){
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.frequency.value = freq;
  osc.start();
  gain.gain.setValueAtTime(1, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration/1000);
  osc.stop(audioCtx.currentTime + duration/1000);
}

function switchMode(m){
  mode = m;
  document.getElementById("upTab").classList.toggle("active", m==="up");
  document.getElementById("downTab").classList.toggle("active", m==="down");
}

function addPerson() {
  const div = document.createElement("div");
  div.className = "person";
  div.innerHTML = `<input placeholder="名前"><input type="number" placeholder="到達時間(秒)">`;
  document.getElementById("inputs").appendChild(div);
}

function calculate() {
  const people = document.querySelectorAll(".person");
  let data = [];

  people.forEach(p => {
    const name = p.children[0].value || "名無し";
    const time = parseFloat(p.children[1].value);
    if (!isNaN(time)) data.push({name, time});
  });

  let html = "<h2>スタート指示</h2>";

  if(mode === "up"){
    const maxTime = Math.max(...data.map(p => p.time));
    startTimes = data.map(p => Math.round(maxTime - p.time));
    endTime = Math.max(...startTimes) + 3;

    data.forEach((p,i)=> html += `<p>${p.name} → ${startTimes[i]} 秒で出発</p>`);

  } else {
    const minTime = Math.min(...data.map(p => p.time));
    downStartTimes = data.map(p => ({
      name: p.name,
      start: Math.round(p.time - minTime)
    }));

    const maxStart = Math.max(...downStartTimes.map(p => p.start));
    endTime = maxStart + 3;

    html += `<p>カウントダウン秒数 → ${endTime}</p>`;
    html += `<h3>出発タイミング</h3>`;
    downStartTimes.forEach(p=>{
      html += `<p>${p.name} → 残り ${p.start} 秒で出発</p>`;
    });
  }

  html += `<button onclick="startTimer()">開始</button>
           <button class="stopBtn" onclick="stopAll()">停止</button>`;
  document.getElementById("startArea").innerHTML = html;
}

function startTimer(){
  stopAll();
  initAudio();
  const display = document.getElementById("mainTimer");

  if(mode === "up"){
    t = 0;
    display.textContent = t;

    interval = setInterval(()=>{
      t++;
      display.textContent = t;
      tone(700,60);

      startTimes.forEach(s=>{
        if(s===t) tone(1000,200);
      });

      if(t>=endTime){
        tone(400,400);
        stopAll();
      }

    },1000);

  } else {
    t = endTime;
    display.textContent = t;

    interval = setInterval(()=>{
      t--;
      display.textContent = t;
      tone(700,60);

      downStartTimes.forEach(p=>{
        if(t===p.start){
          tone(1000,200);
        }
      });

      if(t<=0){
        tone(400,400);
        stopAll();
      }

    },1000);
  }
}

function stopAll(){
  if(interval) clearInterval(interval);
}

addPerson();
</script>
</body>
</html>
