<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>同時ゴール司令塔</title>
<style>
body { font-family:sans-serif; background:#f5f7fa; padding:20px; text-align:center; }
.person { display:flex; gap:10px; margin-bottom:10px; }
input, select { padding:8px; font-size:16px; flex:1; }
button { padding:12px; font-size:18px; margin-top:10px; width:100%; }
#mainTimer { font-size:64px; margin-top:20px; font-weight:bold; }
.stopBtn { background:#ff4d4d; color:white; }
.copyBtn { background:#4caf50; color:white; }
.tabs button { width:32%; }
.active { background:#333; color:white; }
.section { display:none; margin-top:15px; }
.result { margin-top:15px; font-size:18px; }
</style>
</head>
<body>

<h1>同時ゴール司令塔</h1>

<div class="tabs">
  <button id="upTab" class="active" onclick="switchMode('up')">カウントアップ（遠）</button>
  <button id="downTab" onclick="switchMode('down')">カウントダウン（近）</button>
  <button id="utcTab" onclick="switchMode('utc')">UTC出発計算</button>
</div>

<div id="inputs"></div>
<button onclick="addPerson()">参加者を追加</button>

<div id="timerControls" class="section" style="display:block;">
  <button onclick="calculateTimer()">計算する</button>
  <div id="startArea"></div>
  <div id="mainTimer"></div>
</div>

<div id="utcControls" class="section">
  <label>到着予定UTC時刻：</label>
  <input type="datetime-local" id="goalTime">

  <label>集結待機時間：</label>
  <select id="waitTime">
    <option value="60">1分集結</option>
    <option value="300">5分集結</option>
    <option value="600">10分集結</option>
  </select>

  <button onclick="calculateUTC()">出発時刻を計算</button>
  <div id="results" class="result"></div>
</div>

<script>
let mode="up";
let startTimes=[], downStartTimes=[], lastText="";
let audioCtx, interval=null, prepInterval=null;
let t=0, endTime=null;

function initAudio(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }
function tone(f,d){
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  o.frequency.value=f; o.start();
  g.gain.setValueAtTime(1,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+d/1000);
  o.stop(audioCtx.currentTime+d/1000);
}

function switchMode(m){
  mode=m;
  ["up","down","utc"].forEach(x=>{
    document.getElementById(x+"Tab").classList.toggle("active",x===m);
  });
  document.getElementById("timerControls").style.display=(m==="utc")?"none":"block";
  document.getElementById("utcControls").style.display=(m==="utc")?"block":"none";
  stopAll();
}

function addPerson(){
  const d=document.createElement("div");
  d.className="person";
  d.innerHTML=`<input placeholder="名前"><input type="number" placeholder="到達時間(秒)">`;
  document.getElementById("inputs").appendChild(d);
}

function calculateUTC(){
  const goal=document.getElementById("goalTime").value;
  const wait=parseInt(document.getElementById("waitTime").value);
  if(!goal){alert("UTC時刻入れて");return;}

  const goalUTC=new Date(goal+"Z");
  const people=document.querySelectorAll(".person");

  let html="<h2>出発UTC時刻（集結時間含む）</h2>";
  let text="";

  people.forEach(p=>{
    const name=p.children[0].value||"名無し";
    const sec=parseFloat(p.children[1].value);
    if(isNaN(sec)) return;

    const st=new Date(goalUTC.getTime()-(sec+wait)*1000);
    const hh=String(st.getUTCHours()).padStart(2,'0');
    const mm=String(st.getUTCMinutes()).padStart(2,'0');
    const ss=String(st.getUTCSeconds()).padStart(2,'0');

    html+=`<p>${name} → ${hh}:${mm}:${ss} UTC 出発</p>`;
    text+=`${name}: ${hh}:${mm}:${ss} UTC 出発\n`;
  });

  lastText=text;
  html+=`<button class="copyBtn" onclick="copyText()">結果をコピー</button>`;
  document.getElementById("results").innerHTML=html;
}

function copyText(){ navigator.clipboard.writeText(lastText); alert("コピー完了"); }
function stopAll(){ if(interval) clearInterval(interval); if(prepInterval) clearInterval(prepInterval); }

addPerson();
</script>
</body>
</html>
