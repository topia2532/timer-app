<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>同時ゴール司令塔</title>
<style>
body { font-family:sans-serif; background:#f5f7fa; padding:20px; text-align:center; }
.person { display:flex; gap:10px; margin-bottom:10px; }
input { padding:8px; font-size:16px; flex:1; }
button { padding:12px; font-size:18px; margin-top:10px; width:100%; }
#mainTimer { font-size:64px; margin-top:20px; font-weight:bold; }
.stopBtn { background:#ff4d4d; color:white; }
</style>
</head>
<body>

<h1>同時ゴール司令塔</h1>
<div id="inputs"></div>
<button onclick="addPerson()">参加者を追加</button>
<button onclick="calculate()">計算する</button>

<div id="startArea"></div>
<div id="mainTimer"></div>

<script>
let startTimes = [];
let audioCtx;
let prepInterval = null;
let mainInterval = null;
let t = 0;

function initAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function tone(freq, duration){
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.frequency.value = freq;
  osc.type = "sine";
  osc.start();
  gain.gain.setValueAtTime(1, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration/1000);
  osc.stop(audioCtx.currentTime + duration/1000);
}

function addPerson() {
  const div = document.createElement("div");
  div.className = "person";
  div.innerHTML = `
    <input placeholder="名前">
    <input type="number" placeholder="到達時間(秒)">
  `;
  document.getElementById("inputs").appendChild(div);
}

function calculate() {
  const people = document.querySelectorAll(".person");
  let data = [];

  people.forEach(p => {
    const name = p.children[0].value || "名無し";
    const time = parseFloat(p.children[1].value);
    if (!isNaN(time)) data.push({name, time});
  });

  const maxTime = Math.max(...data.map(p => p.time));
  startTimes = data.map(p => Math.round(maxTime - p.time));

  let html = "<h2>スタート番号</h2>";
  data.forEach((p,i) => {
    html += `<p>${p.name} → ${startTimes[i]}</p>`;
  });

  html += `
    <button onclick="startMasterTimer()">全員スタート</button>
    <button class="stopBtn" onclick="stopAll()">停止</button>
  `;
  document.getElementById("startArea").innerHTML = html;
}

function startMasterTimer() {
  stopAll();
  initAudio();

  let prep = 5;
  const display = document.getElementById("mainTimer");

  prepInterval = setInterval(() => {
    display.textContent = prep;
    tone(500,120);
    prep--;
    if (prep < 0) {
      clearInterval(prepInterval);
      tone(1500,400);
      runMain();
    }
  }, 1000);
}

function runMain() {
  t = 0;
  const display = document.getElementById("mainTimer");
  display.textContent = t;

  mainInterval = setInterval(() => {
    t++;
    display.textContent = t;

    tone(700,60); // 毎秒のカウント音

    startTimes.forEach(s => {
      if (s === t) {
        tone(1000,200); // 出発合図音
      }
    });
  }, 1000);
}

function stopAll(){
  if(prepInterval) clearInterval(prepInterval);
  if(mainInterval) clearInterval(mainInterval);
}

addPerson();
</script>
</body>
</html>
